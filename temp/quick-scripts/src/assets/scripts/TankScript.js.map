{"version":3,"sources":["assets/scripts/TankScript.js"],"names":["TankType","require","tankType","cc","Class","Component","properties","Normal","type","speed","bullet","Prefab","fireTime","blood","team","blast","shootAudio","url","AudioClip","die","onLoad","_cityCtrl","find","getComponent","bulletNode","start","stopMove","offset","v2","Player","self","callback","callFunc","angles","index","parseInt","Math","random","tankMoveStart","startFire","bulletPool","seq","sequence","delayTime","node","runAction","repeatForever","angle","floor","cos","PI","sin","ceil","tankMoveStop","update","dt","boundingBox","getBoundingBox","rect","xMin","x","yMin","y","size","width","height","collisionTest","collisionTank","stopFire","i","gameData","tankList","length","tank","intersects","get","instantiate","pos","position","add","bulletMove","parent","camp","bulletList","push","boom","anim","Animation","play","tankBoom"],"mappings":"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","sourceRoot":"/","sourcesContent":["\nvar TankType = require(\"TankData\").tankType;\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n\n        //坦克类型\n        tankType: {\n            default: TankType.Normal,\n            type: TankType\n        }, \n        //速度\n        speed: 20,\n        //子弹\n        bullet: cc.Prefab,\n        //发射子弹间隔时间\n        fireTime: 0.5,\n        //血量\n        blood: 1,\n        //所属组织\n        team: 0,\n        //爆炸动画\n        blast: cc.Prefab,\n        //射击音效\n        shootAudio: {\n            default: null,\n            url: cc.AudioClip,\n        },\n\n        die: false,\n\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        //获取组件\n        this._cityCtrl = cc.find(\"/CityScript\").getComponent(\"CityScript\");\n        this.bulletNode = cc.find(\"/Canvas/Map/bullet\");\n    },\n\n    start: function() {\n        //初始是停止状态的\n        this.stopMove = true;\n        //偏移量\n        this.offset = cc.v2();\n\n        if(this.tankType != TankType.Player){\n            var self = this;\n            //添加AI\n            var callback = cc.callFunc(function(){\n                var angles = [0, 90, 180, 270];\n                var index = parseInt(Math.random()*4, 10);\n                self.tankMoveStart(angles[index]);\n\n                self.startFire(self._cityCtrl.bulletPool);\n\n            }, this);\n\n            var seq = cc.sequence(cc.delayTime(0.3), callback, cc.delayTime(1));\n            this.node.runAction(cc.repeatForever(seq));\n        }\n\n    },\n\n    //添加坦克移动动作\n    tankMoveStart: function (angle) {\n\n        this.node.angle = angle - 90;\n\n        if(angle==0 || angle==180 || angle==90){\n            this.offset = cc.v2(Math.floor(Math.cos(Math.PI/180*angle)), \n                           Math.floor(Math.sin(Math.PI/180*angle)));\n        }else if(angle==270){\n\n            this.offset = cc.v2(Math.ceil(Math.cos(Math.PI/180*angle)),\n                                Math.floor(Math.sin(Math.PI/180*angle)));\n        }else {\n            this.offset = cc.v2(Math.cos(Math.PI/180*angle),\n                                Math.sin(Math.PI/180*angle));\n        }\n\n        this.stopMove = false;\n    },\n\n    //移除坦克移动动作\n    tankMoveStop: function () {\n        this.stopMove = true;\n    },\n\n    // called every frame, uncomment this function to activate update callback\n    update: function (dt) {\n        if(!this.stopMove){\n            var boundingBox = this.node.getBoundingBox();\n            var rect = cc.rect(boundingBox.xMin + this.offset.x*this.speed*dt*1.5,\n                               boundingBox.yMin + this.offset.y*this.speed*dt*1.7, \n\t\t                       boundingBox.size.width, \n                               boundingBox.size.height);\n            if(this._cityCtrl.collisionTest(rect) //检测与地图的碰撞\n                || this.collisionTank(rect)\n                ){\n                this.tankMoveStop();\n            }else {\n                this.node.x += this.offset.x*this.speed*dt;\n                this.node.y += this.offset.y*this.speed*dt;\n            }\n        }\n        if(this.stopFire){\n            this.fireTime -= dt;\n            if(this.fireTime<=0){\n                this.stopFire = false;\n            }\n        }\n\n    },\n\n    //判断是否与其他坦克碰撞\n    collisionTank: function(rect) {\n        for(var i=0; i<cc.gameData.tankList.length; i++){\n            var tank = cc.gameData.tankList[i]\n            if(this.node === tank){\n                continue;\n            }\n            var boundingBox = tank.getBoundingBox();\n            // if(cc.rectIntersectsRect(rect, boundingBox)){\n            if(rect.intersects(boundingBox)){  \n                return true;\n            }\n        }\n        return false;\n    },\n\n    //开火\n    startFire: function (bulletPool){\n        if(this.stopFire){\n            return false;\n        }\n        this.stopFire = true;\n        this.fireTime = 0.5;\n\n        var bullet = null;\n        if(bulletPool.size()>0){\n            bullet = bulletPool.get(bulletPool);\n        }else {\n            bullet = cc.instantiate(this.bullet);\n        }\n        //设置子弹位置,角度\n        bullet.angle = this.node.angle;\n        var pos = this.node.position;\n\n        var angle = this.node.angle - 90;\n        var offset = cc.v2(0, 0);\n        if(angle==0 || angle==180 || angle==90){\n            offset = cc.v2(Math.floor(Math.cos(Math.PI/180*angle)), \n                                Math.floor(Math.sin(Math.PI/180*angle)));\n        }else if(angle==270){\n            offset = cc.v2(Math.ceil(Math.cos(Math.PI/180*angle)),\n                                Math.floor(Math.sin(Math.PI/180*angle)));\n        }else {\n            offset = cc.v2(Math.cos(Math.PI/180*angle),\n                                Math.sin(Math.PI/180*angle));\n        }\n\n        if(angle == -90){\n            //cc.log(\"上\");\n            bullet.position = pos.add(cc.v2(10*offset.x, 10*offset.y + 15));\n        }else if(angle == 0){\n            //cc.log(\"左\");\n            bullet.position = pos.add(cc.v2(10*offset.x - 15, 10*offset.y));\n        }else if(angle == -180){\n            //cc.log(\"右\");\n            bullet.position = pos.add(cc.v2(10*offset.x + 15, 10*offset.y));\n        }else if(angle == 90){\n            //cc.log(\"下\");\n            bullet.position = pos.add(cc.v2(10*offset.x, 10*offset.y - 15));\n        }\n\n        // bullet.position = cc.pAdd(pos,cc.v2(10*offset.x, 10*offset.y));\n\n        bullet.getComponent(\"BulletScript\").bulletMove();\n        bullet.parent = this.bulletNode;\n        //子弹标记\n        bullet.camp = this.team;\n        \n\n        //加到列表\n        cc.gameData.bulletList.push(bullet);\n\n        return true;\n    },\n\n    //爆炸\n    boom: function(){\n        var blast = cc.instantiate(this.blast);\n        blast.parent = this.node.parent;\n        blast.position = this.node.position;\n        var anim = blast.getComponent(cc.Animation);\n        anim.play();\n        this._cityCtrl.tankBoom(this.node);\n    },\n\n});\n"]}